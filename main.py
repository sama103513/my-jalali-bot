import os
import jdatetime
from datetime import datetime
import pytz  # Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØªÙ‡Ø±Ø§Ù†
from pyrogram import Client, filters
from pyrogram.types import Message

# ---------------------------------------------------------
# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª
# ---------------------------------------------------------
# Ø§ÛŒÙ† API Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø§Ø®Øª Ø§Ú©Ø§Ù†Øª Ø§Ø®ØªØµØ§ØµÛŒ Ù†Ø¯Ø§Ø±Ø¯
API_ID = 2040
API_HASH = "b18441a1ff607e10a989891a5462e627"

# Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ (Ù…Ø­ÛŒØ· Railway/Glitch)
BOT_TOKEN = os.environ.get("BOT_TOKEN")

APP_NAME = "my_jalali_bot"

# ---------------------------------------------------------
# Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª Ø±Ø¨Ø§Øª
# ---------------------------------------------------------
app = Client(
    name=APP_NAME,
    api_id=API_ID,
    api_hash=API_HASH,
    bot_token=BOT_TOKEN
)

# ---------------------------------------------------------
# ØªØ§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ù¾Ø§ÛŒØªÙˆÙ† Ùˆ jdatetime)
# ---------------------------------------------------------
def get_persian_date():
    # ØªÙ†Ø¸ÛŒÙ… Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ù‡ ØªÙ‡Ø±Ø§Ù† ØªØ§ Ø³Ø§Ø¹Øª Ø¯Ù‚ÛŒÙ‚ Ø§ÛŒØ±Ø§Ù† Ø¨Ø§Ø´Ø¯
    tehran_tz = pytz.timezone("Asia/Tehran")
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ
    now = datetime.now(tehran_tz)
    
    # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
    j_date = jdatetime.date.fromgregorian(date=now)
    
    # Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ø±ÙˆØ² Ù‡ÙØªÙ‡ (Ù…Ø«Ù„Ø§Ù‹ Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡)
    day_name = j_date.strftime("%A")
    
    # ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
    # Ù†Ú©ØªÙ‡: Ø¯Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ jdatetime Ø§Ø² year Ø¨Ù‡ Ø¬Ø§ÛŒ jyear Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    formatted_date = f"{day_name} {j_date.year}/{j_date.month:02d}/{j_date.day:02d}"
    
    return formatted_date

# ---------------------------------------------------------
# Ø¯Ø³ØªÙˆØ± Ø´Ø±ÙˆØ¹
# ---------------------------------------------------------
@app.on_message(filters.command("start"))
async def start(client: Client, message: Message):
    await message.reply_text("ğŸ‘‹ Ø³Ù„Ø§Ù…! Ù…Ù† Ø±Ø¨Ø§Øª Ù‡Ø³ØªÙ….\n\nÙ‡Ø± Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒÙ… Ø¨ÙØ±Ø³ØªÛŒØŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ùˆ Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø±Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¢Ù† Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ù….")

# ---------------------------------------------------------
# Ù‡Ù†Ø¯Ù„Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ùˆ Ø§ÙØ²ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®
# ---------------------------------------------------------
@app.on_message(filters.text & ~filters.command("start"))
async def footer_handler(client: Client, message: Message):
    try:
        # Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
        original_text = message.text
        
        # Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
        date_str = get_persian_date()
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù…ØªÙ†
        new_text = f"{original_text}\n\nğŸ“… {date_str}"
        
        # Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®
        await message.reply(new_text, quote=True)
        
    except Exception as e:
        # Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ± (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)
        print(f"Error: {e}")

# ---------------------------------------------------------
# Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
# ---------------------------------------------------------
print("Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª...")
app.run()
